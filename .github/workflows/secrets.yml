name: Scan for Secrets
on: [push]

jobs:
  trufflehog:
    name: Scan with TruffleHog
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        entropy: ["--entropy=False", "--entropy=True"]
        regex: ["", "--regex"]
    
    steps:
    - uses: actions/checkout@v2
    - run: pip3 freeze > $GITHUB_WORKSPACE/../cache.key
    - name: Cache pip dependancies
      uses: actions/cache@v1
      with:
        path: $GITHUB_WORKSPACE/../.packages  # dependancies installed in this directory
        key: ${{ runner.os }}-node-${{ hashFiles('**/../cache.key') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-
          
    - run: |
        pwd
        ls -al ~
        ls -al $GITHUB_WORKSPACE/../.packages
        ls -al .

    # @todo port trufflehog parameters to new call
    # - uses: max/secret-scan@1.0.0   # no parameters passed, nothing to import
    # - uses: edplato/trufflehog-actions-scan@v0.9e-beta  # --regex --entropy=False --max_depth=50

    - name: Set up Python 3.7
      uses: actions/setup-python@v1
      with:
        python-version: 3.7
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install --install-option="--prefix=$GITHUB_WORKSPACE/../.packages" truffleHog
    - run: trufflehog ${{ matrix.entropy }} ${{ matrix.regex }} $GITHUB_WORKSPACE
    - run: |
        pwd
        ls -al ~
        ls -al $GITHUB_WORKSPACE/../.packages
        ls -al .
        python3 -m site --user-site
    - run: pip3 freeze > $GITHUB_WORKSPACE/../cache.key
    
  gitleak:
    name: Scan with GitLeak
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2
      - name: Set up Go v1
        uses: actions/setup-go@v1
        with:
          go-version: 1.13
        id: go
      - name: Install dependencies
      # @todo should this 'go get' be removed?
        run: |
          go get -v -t -d ./...
          if [ -f Gopkg.toml ]; then
              curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
              dep ensure
          fi
          go get -u github.com/zricethezav/gitleaks

      # @todo command is failing
      - run: go run gitleaks -v --exclude-forks --redact --threads=1 --branch=$GITHUB_REF --repo-path=$GITHUB_WORKSPACE
      
      # @todo port gitleaks parameters to new call
      - uses: eshork/gitleaks-action@v1.0.0
      # uses: CySeq/gitcret@v2
          
  seekret:
    name: Scan with Seekret
    runs-on: [ubuntu-latest]
    steps:
      # @todo implement a seekret call
      - run: echo "hello world"
    # https://github.com/cds-snc/github-actions/tree/master/seekret
      
